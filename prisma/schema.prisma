generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

//////////////////////////////////////////////////////
// ç”¨æˆ·
//////////////////////////////////////////////////////

model User {
  id                String   @id @default(uuid())
  email             String   @unique
  name              String?
  avatar            String?
  backgroundImage   String?
  briefIntroduction String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // å‘å¸ƒå†…å®¹
  posts Post[]

  // äº’åŠ¨
  likes     Like[]
  bookmarks Bookmark[]
  shares    Share[]

  // èŠå¤©
  conversationParticipants ConversationParticipant[]
  conversationReads        ConversationRead[]
  messages                 Message[] @relation("SentMessages")
}

//////////////////////////////////////////////////////
// å¸–å­ï¼ˆæ”¯æŒé€’å½’è¯„è®ºï¼‰
//////////////////////////////////////////////////////

model Post {
  id        String   @id @default(cuid())
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // é€’å½’è¯„è®ºç»“æ„
  parentId String?
  parent   Post?  @relation("PostToPost", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Post[] @relation("PostToPost")

  // æ ¹å¸– idï¼ˆè¯é¢˜èšåˆï¼‰
  rootId String?

  // å†—ä½™è®¡æ•°ï¼ˆé«˜æ€§èƒ½ï¼‰
  likeCount  Int @default(0)
  replyCount Int @default(0)
  shareCount Int @default(0)
  starCount  Int @default(0)

  // äº’åŠ¨å…³ç³»
  likes     Like[]
  bookmarks Bookmark[]
  shares    Share[]

  // ç´¢å¼•ä¼˜åŒ–
  @@index([parentId])
  @@index([rootId, createdAt])
  @@index([authorId])
}

//////////////////////////////////////////////////////
// ç‚¹èµ
//////////////////////////////////////////////////////

model Like {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
}

//////////////////////////////////////////////////////
// æ”¶è—
//////////////////////////////////////////////////////

model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
}

//////////////////////////////////////////////////////
// åˆ†äº«
//////////////////////////////////////////////////////

model Share {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  // å¦‚æœä¸å…è®¸é‡å¤åˆ†äº«å°±ä¿ç•™
  @@unique([userId, postId])

  @@index([userId])
  @@index([postId])
}

//////////////////////////////////////////////////////
// ä¼šè¯ï¼ˆæ”¯æŒç§èŠ & ç¾¤èŠï¼‰
//////////////////////////////////////////////////////

model Conversation {
  id        String   @id @default(uuid())
  isGroup   Boolean  @default(false)
  name      String?
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // èŠå¤©ä¼˜åŒ–å­—æ®µ
  lastMessage       String?
  lastMessageAt     DateTime?
  messageCount      Int       @default(0)   // ğŸ”¥ ç”¨äº unread O(1)

  participants ConversationParticipant[]
  messages     Message[]
  readStates   ConversationRead[]

  @@index([lastMessageAt])
}

//////////////////////////////////////////////////////
// ä¼šè¯å‚ä¸è€…
//////////////////////////////////////////////////////

model ConversationParticipant {
  id             String   @id @default(uuid())
  conversationId String
  userId         String
  joinedAt       DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
}

//////////////////////////////////////////////////////
// æ¶ˆæ¯
//////////////////////////////////////////////////////

model Message {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String

  type           String   @default("text") // text | image | file | system
  content        String?  @db.Text

  createdAt DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([senderId])
}

//////////////////////////////////////////////////////
// æœªè¯»çŠ¶æ€ï¼ˆO(1) æœªè¯»è®¡ç®—ï¼‰
//////////////////////////////////////////////////////

model ConversationRead {
  id             String   @id @default(uuid())
  conversationId String
  userId         String

  lastReadMessageCount Int @default(0)  // ğŸ”¥ å…³é”®ä¼˜åŒ–
  updatedAt            DateTime @updatedAt

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
}
